{"version":3,"sources":["api/contact/contact.controller.js"],"names":["syncContact","handleError","res","argStatusCode","err","error","statusCode","status","send","updateContacts","contacts","userId","groupId","contact","shift","name","number","Contact","find","where","then","item","update","resolve","create","contactId","id","GroupContact","findOrCreate","catch","req","body","json","message","Group","user","group","end"],"mappings":";;;;;;;;;;;;;;QAyBgBA,W,GAAAA,W;;AAzBhB;;;;AACA;;;;;;AAEA,SAASC,WAAT,CAAqBC,GAArB,EAA0BC,aAA1B,EAAyCC,GAAzC,EAA8C;AAC5C,mBAAOC,KAAP,CAAa,iBAAb,EAAgCD,GAAhC;AACA,MAAME,aAAaH,iBAAiB,GAApC;AACAD,MAAIK,MAAJ,CAAWD,UAAX,EAAuBE,IAAvB,CAA4BJ,GAA5B;AACD;;AAED,SAASK,cAAT,OAAsD;AAAA,MAA5BC,QAA4B,QAA5BA,QAA4B;AAAA,MAAlBC,MAAkB,QAAlBA,MAAkB;AAAA,MAAVC,OAAU,QAAVA,OAAU;;AACpD,MAAMC,UAAUH,SAASI,KAAT,EAAhB;AACA,MAAID,OAAJ,EAAa;AAAA,QACHE,IADG,GACcF,OADd,CACHE,IADG;AAAA,QACGC,MADH,GACcH,OADd,CACGG,MADH;;AAEX,WAAO,gBAAGC,OAAH,CAAWC,IAAX,CAAgB,EAAEC,OAAO,EAAEH,cAAF,EAAUL,cAAV,EAAT,EAAhB,EACJS,IADI,CACC;AAAA,aAASC,OACXA,KAAKC,MAAL,CAAY,EAAEP,UAAF,EAAZ,EAAsBK,IAAtB,CAA2B;AAAA,eAAM,kBAAQG,OAAR,CAAgBF,IAAhB,CAAN;AAAA,OAA3B,CADW,GAEX,gBAAGJ,OAAH,CAAWO,MAAX,CAAkB,EAAET,UAAF,EAAQC,cAAR,EAAgBL,cAAhB,EAAlB,CAFE;AAAA,KADD,EAIJS,IAJI,CAIC;AAAA,UAAOK,SAAP,SAAGC,EAAH;AAAA,aAAuB,gBAAGC,YAAH,CAC1BC,YAD0B,CACb,EAAET,OAAO,EAAEP,gBAAF,EAAWa,oBAAX,EAAT,EADa,CAAvB;AAAA,KAJD,EAMJL,IANI,CAMC;AAAA,aAAMX,eAAe,EAAEC,kBAAF,EAAYC,cAAZ,EAAoBC,gBAApB,EAAf,CAAN;AAAA,KAND,EAOJiB,KAPI,CAOE;AAAA,aAAMpB,eAAe,EAAEC,kBAAF,EAAYC,cAAZ,EAAoBC,gBAApB,EAAf,CAAN;AAAA,KAPF,CAAP;AAQD;AACD,SAAO,kBAAQW,OAAR,EAAP;AACD;;AAEM,SAASvB,WAAT,CAAqB8B,GAArB,EAA0B5B,GAA1B,EAA+B;AAAA,kBACT4B,IAAIC,IADK;AAAA,MAC5BhB,IAD4B,aAC5BA,IAD4B;AAAA,MACtBL,QADsB,aACtBA,QADsB;;AAEpC,MAAI,CAACK,IAAD,IAAS,CAACL,QAAd,EAAwB,OAAOR,IAAIK,MAAJ,CAAW,GAAX,EAAgByB,IAAhB,CAAqB,EAAEC,SAAS,iBAAX,EAArB,CAAP;AACxB,SAAO,gBAAGC,KAAH,CACJN,YADI,CACS,EAAET,OAAO,EAAEJ,UAAF,EAAQJ,QAAQmB,IAAIK,IAAJ,CAAST,EAAzB,EAAT,EADT,EAEJN,IAFI,CAEC;AAAA;AAAA,QAAEgB,KAAF;;AAAA,WAAa3B,eAAe,EAAEC,kBAAF,EAAYC,QAAQmB,IAAIK,IAAJ,CAAST,EAA7B,EAAiCd,SAASwB,MAAMV,EAAhD,EAAf,CAAb;AAAA,GAFD,EAGJN,IAHI,CAGC;AAAA,WAAMlB,IAAImC,GAAJ,EAAN;AAAA,GAHD,EAIJR,KAJI,CAIE;AAAA,WAAO5B,YAAYC,GAAZ,EAAiB,GAAjB,EAAsBE,GAAtB,CAAP;AAAA,GAJF,CAAP;AAKD","file":"contact.controller.js","sourcesContent":["import logger from '../../components/logger';\nimport db from '../../conn/sqldb';\n\nfunction handleError(res, argStatusCode, err) {\n  logger.error('user.controller', err);\n  const statusCode = argStatusCode || 500;\n  res.status(statusCode).send(err);\n}\n\nfunction updateContacts({ contacts, userId, groupId}) {\n  const contact = contacts.shift();\n  if (contact) {\n    const { name, number } = contact;\n    return db.Contact.find({ where: { number, userId } })\n      .then(item => (item\n        ? item.update({ name }).then(() => Promise.resolve(item))\n        : db.Contact.create({ name, number, userId })))\n      .then(({ id: contactId }) => db.GroupContact\n        .findOrCreate({ where: { groupId, contactId } }))\n      .then(() => updateContacts({ contacts, userId, groupId }))\n      .catch(() => updateContacts({ contacts, userId, groupId }));\n  }\n  return Promise.resolve();\n}\n\nexport function syncContact(req, res) {\n  const { name, contacts } = req.body;\n  if (!name || !contacts) return res.status(500).json({ message: 'Invalid Request' });\n  return db.Group\n    .findOrCreate({ where: { name, userId: req.user.id } })\n    .then(([group]) => updateContacts({ contacts, userId: req.user.id, groupId: group.id }))\n    .then(() => res.end())\n    .catch(err => handleError(res, 500, err));\n}\n"]}