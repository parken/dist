{"version":3,"sources":["api/user/user.controller.js"],"names":["wStates","me","index","show","showUuid","create","signup","login","refresh","logout","duplicate","update","checkExists","otpLogin","otpSend","otpVerify","passwordChange","sendLogin","loginUid","addSellingRootUser","addSelling","handleError","res","argStatusCode","err","console","log","error","statusCode","status","send","req","WState","findAll","attributes","raw","then","json","wS","catch","User","findById","user","id","u","data","find","where","params","LoginIdentifier","uuid","include","model","required","loginIdentifier","message","body","mobile","length","supportMobile","groupId","createdBy","name","password","otp","email","error_description","otpStatus","end","getApp","code","AuthCode","auth_code","App","authCode","toJSON","options","url","OAUTH_SERVER","OAUTH_ENDPOINT","auth","app","clientId","pass","clientSecret","headers","connection","remoteAddress","form","grant_type","redirect_uri","redirectUri","username","post","apires","RefreshToken","refreshToken","refresh_token","next","revokeToken","access_token","up","query","count","alternateMobile","findOrCreate","newUser","Math","floor","random","text","to","$or","revokeTokens","origin","userId","routeId","limit","roleId","Selling","updatedBy","sendingUserId","fromUserId"],"mappings":"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","file":"user.controller.js","sourcesContent":["import request from 'request';\nimport config from '../../config/environment';\nimport logger from '../../components/logger';\nimport { sms, slack } from '../../components/notify';\nimport oAuthModel from '../../components/oauth/model';\nimport { getRouteType } from '../../conn/sqldb/helper';\n\nimport db from '../../conn/sqldb';\n\nfunction handleError(res, argStatusCode, err) {\n  console.log(err)\n  logger.error('user.controller', err);\n  const statusCode = argStatusCode || 500;\n  res.status(statusCode).send(err);\n}\n\nexport function wStates(req, res) {\n  return db.WState\n    .findAll({attributes: ['id', 'name'], raw: true})\n    .then(wS => res.json(wS))\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function me(req, res) {\n  return db.User\n    .findById(req.user.id, {\n      attributes: ['mobile', 'email', 'name', 'id', 'roleId', 'admin'],\n      raw: 'true',\n    })\n    .then(u => res.json(u))\n    .catch(err => handleError(res, 500, err));\n}\n\n\nexport function index(req, res) {\n  return db.User\n    .findAll()\n    .then(data => res.json(data))\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function show(req, res) {\n  return db.User\n    .find({\n      where: { id: req.params.id },\n      attributes: ['id', 'name', 'email', 'mobile'],\n    })\n    .then(data => res.json(data))\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function showUuid(req, res) {\n  return db.LoginIdentifier\n    .find({\n      where: { uuid: req.params.uuid },\n      attributes: ['id'],\n      include: [{\n        model: db.User,\n        attributes: ['id', 'mobile', 'otp'],\n        required: true,\n      }],\n    })\n    .then((loginIdentifier) => {\n      if (!loginIdentifier) return res.status(404).json({ message: 'Invalid Request' })\n      return res.json(loginIdentifier.User);\n    })\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function create(req, res) {\n  const user = req.body;\n  if (`${user.mobile}`.length === 10) user.mobile += 910000000000;\n  if (`${user.supportMobile}`.length === 10) user.supportMobile += 910000000000;\n  user.groupId = 2;\n  user.createdBy = req.user.id;\n  return db.User\n    .create(user)\n    .then(data => res.json(data))\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function signup(req, res) {\n  const { id, name, password, otp, email } = req.body;\n  db.User.find({\n    attributes: ['id'],\n    where: { id, otp },\n  })\n    .then((u) => {\n      if (!u) return res.status(400).json({ error_description: 'Invalid OTP' });\n      u\n        .update({ otpStatus: 0, name, password, email })\n        .catch(err => logger.error('user.ctrl/otpVerify', err));\n      slack(`Signup: ${u.id}, ${u.name}, ${u.mobile}, ${u.email}`);\n      return res.status(201).end();\n    }).catch(err => handleError(res, 500, err));\n}\n\nfunction getApp(code) {\n  return db.AuthCode.find({ where: { auth_code: code }, include: [db.App] })\n    .then(authCode => authCode.App.toJSON());\n}\n\nexport function login(req, res) {\n  const { code } = req.body;\n  return (code\n    ? getApp(code)\n    : db.App.findById(1, { raw: true }))\n    .then(app => {\n      const options = {\n        url: `${config.OAUTH_SERVER}${config.OAUTH_ENDPOINT}`,\n        auth: {\n          user: app.clientId,\n          pass: app.clientSecret,\n        },\n        headers: {\n          'user-agent': req.headers['user-agent'],\n          'x-forwarded-for': req.headers['x-forwarded-for'] || req.connection.remoteAddress,\n        },\n      };\n\n      options.form = code\n        ? { grant_type: 'authorization_code', redirect_uri: `${app.redirectUri}`, code }\n        : { grant_type: 'password', username: req.body.username, password: req.body.password };\n\n      request.post(options, (err, apires, body) => {\n        if (err) return res.status(500).json({ err, body });\n        return res.status(apires.statusCode).send(body);\n      });\n    });\n}\n\nexport function refresh(req, res) {\n  return db.App\n    .find({\n      include: [{\n        model: db.RefreshToken,\n        where: { refreshToken: req.body.refresh_token },\n        required: true,\n      }],\n    })\n    .then(app => {\n      if (!app) return res.status(400).json({ message: 'Invalid Token' });\n      const options = {\n        url: `${config.OAUTH_SERVER}${config.OAUTH_ENDPOINT}`,\n        auth: {\n          user: app.clientId,\n          pass: app.clientSecret,\n        },\n        form: {\n          grant_type: 'refresh_token',\n          refresh_token: req.body.refreshToken,\n        },\n        headers: {\n          'user-agent': req.headers['user-agent'],\n          'x-forwarded-for': req.headers['x-forwarded-for'] || req.connection.remoteAddress,\n        },\n      };\n      return request\n        .post(options, (err, apires, body) => {\n          if (err) return res.status(500).send(err);\n          return res.status(apires.statusCode).send(body);\n        });\n    });\n}\n\nexport function logout(req, res, next) {\n  return oAuthModel\n    .revokeToken(req.body.access_token)\n    .then(up => res.status(200).json(up))\n    .catch(next);\n}\n\nexport function duplicate(req, res) {\n  const mobile = `91${req.query.mobile}`;\n  return db.User\n    .count({ where: { mobile } })\n    .then(data => res.json({ mobile: !!data }))\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function update(req, res) {\n  const id = req.user.id || req.params.id;\n  const user = req.body;\n  delete user.id;\n  if (req.user.id) {\n    delete user.alternateMobile;\n  }\n  return db.User\n    .update(user, {\n      where: {\n        id,\n      },\n    })\n    .then(() => res.json({id}))\n    .catch(err => handleError(res, 500, err));\n}\n\n// Check email and phone exists\nexport function checkExists(req, res) {\n  return db.User\n    .checkExists(db, req.query.email, req.query.mobile)\n    .then(status => res.json(status))\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function otpLogin(req, res) {\n  return db.User\n    .findOrCreate({\n      where: {\n        mobile: req.body.username || req.body.mobile,\n      },\n      attributes: ['id', 'otpStatus', 'otp', 'mobile'],\n    }).then(([user, newUser]) => {\n      if (!user) {\n        return res.status(400).json({\n          message: 'User Details not matching with our records. Please contact support'\n        });\n      }\n\n      const otp = user.otpStatus === 1 && user.otp\n        ? user.otp\n        : Math.floor(Math.random() * 90000) + 10000;\n\n      const text = `${otp} is your OTP. Treat this as confidential. Sharing it with anyone gives` +\n        'them full access to your account. We never call you to verify OTP.';\n      if (user.mobile) sms({to: user.mobile, text});\n      db.User\n        .update({otp, otpStatus: 1}, {where: {id: user.id}})\n        .catch(err => logger.error('user.ctrl/otp', err));\n      return res.json({message: 'success', id: user.id, newUser});\n    }).catch(err => handleError(res, 500, err));\n}\n\nexport function otpSend(req, res) {\n  db.User.find({\n    where: {\n      $or: {\n        email: req.body.username,\n        mobile: req.body.username,\n      },\n    },\n    attributes: ['id', 'otpStatus', 'otp', 'mobile'],\n  }).then((user) => {\n    if (!user) {\n      return res.status(400).json({\n        message: 'User Details not matching with our records. Please contact support'\n      });\n    }\n\n    const otp = user.otpStatus === 1 && user.otp\n      ? user.otp\n      : Math.floor(Math.random() * 90000) + 10000;\n\n    const text = `${otp} is your OTP. Treat this as confidential. Sharing it with anyone gives` +\n      'them full access to your account. We never call you to verify OTP.';\n    if (user.mobile) sms({to: user.mobile, text});\n    db.User\n      .update({otp, otpStatus: 1}, {where: {id: user.id}})\n      .catch(err => logger.error('user.ctrl/otp', err));\n    return res.json({message: 'success', id: user.id});\n  }).catch(err => handleError(res, 500, err));\n}\n\nexport function otpVerify(req, res) {\n  db.User.find({\n    attributes: ['id'],\n    where: {\n      $or: [{ id: req.body.id }, { mobile: req.body.mobile }],\n      otp: req.body.otp,\n    },\n  })\n    .then((user) => {\n      if (!user) return res.status(400).json({error_description: 'Invalid OTP'});\n      user\n        .update({otpStatus: 0})\n        .catch(err => logger.error('user.ctrl/otpVerify', err));\n      return res.json({message: 'success', id: user.id});\n    }).catch(err => handleError(res, 500, err));\n}\n\n\n// Creates a new User in the DB\nexport function passwordChange(req, res) {\n  return db.User.find({\n    where: {\n      id: req.body.id,\n      otp: req.body.otp,\n    },\n    attributes: ['id', 'mobile', 'email', 'name'],\n  }).then(u => {\n    if (!u) {\n      return res\n        .status(400)\n        .json({error: 'Invalid password', error_description: 'Invalid current password'});\n    }\n\n    return u.update({password: req.body.password})\n      .then(() => {\n        res.status(204).end();\n        u.revokeTokens(db); // revoke all\n        const {id, name, mobile, email} = u;\n        return slack(`Password change: ${id}, ${name}, ${mobile}, ${email}`);\n      });\n  })\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function sendLogin(req, res) {\n  return db.User\n    .find({ where: { id: req.params.id } })\n    .then(user => {\n      if (!user) return res.status(404).end();\n      const otp = user.otpStatus === 1 && user.otp\n        ? user.otp\n        : Math.floor(Math.random() * 90000) + 10000;\n\n      const text = `Your account has been created click on the link to login ${\n        req.origin}/home?otp=${otp}&id=${user.mobile}`;\n\n      if (user.mobile) sms({to: user.mobile, text});\n      db.User\n        .update({otp, otpStatus: 1}, {where: {id: user.id}})\n        .catch(err => logger.error('user.ctrl/otp', err));\n      return res.json({message: 'success', id: user.id});\n    })\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function loginUid(req, res) {\n  return res.status(500).json({});\n}\n\nexport function addSellingRootUser(req, res) {\n  const { userId, routeId, limit } = req.body;\n  if (!userId || !routeId || !limit || req.user.roleId !== 1) {\n    return res.status(404).json({ message: 'Invalid Request.' });\n  }\n  return db.Selling.create({ userId, routeId, limit, createdBy: req.user.id,\n    updatedBy: req.user.id })\n    .then(() => res.status(202).end())\n    .catch(err => handleError(res, 500, err));\n}\n\nexport function addSelling(req, res) {\n  const { userId, sendingUserId, routeId, limit, fromUserId } = req.body;\n  if (!userId || !sendingUserId || !routeId || !limit) {\n    return res.status(404).json({ message: 'Invalid Request.' });\n  }\n  if (req.user[`sellingBalance${getRouteType(routeId)}`] < limit) {\n    return res.status(404).json({ message: 'Limit Exceeded.' });\n  }\n  return db.Selling.create({ userId, sendingUserId, routeId, limit,\n    fromUserId: fromUserId || req.user.id, createdBy: req.user.id, updatedBy: req.user.id })\n    .then(() => res.status(202).end())\n    .catch(err => handleError(res, 500, err));\n}\n"]}