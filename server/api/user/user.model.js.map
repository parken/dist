{"version":3,"sources":["api/user/user.model.js"],"names":["sequelize","DataTypes","User","define","id","type","INTEGER","allowNull","primaryKey","autoIncrement","name","STRING","mobile","email","otp","otpStatus","password","active","BOOLEAN","admin","companyName","companyLogo","supportName","supportMobile","BIGINT","supportEmail","loginUrl","slackUrl","slackActive","smsActive","transactionalStartFrom","transactionalPercent","promotionalStartFrom","promotionalPercent","otpStartFrom","otpPercent","senderIdStartFrom","senderIdPercent","expiresAt","DATE","sellingBalanceTransactional","sendingBalanceTransactional","sellingBalancePromotional","sendingBalancePromotional","sellingBalanceSenderId","sendingBalanceSenderId","sellingBalanceOTP","sendingBalanceOTP","tableName","timestamps","paranoid","instanceMethods","hashPassword","createHash","update","salt","digest","verifyPasswordAsync","hashedPass","resolve","pick","toJSON","reject","code","message","verifyPassword","cb","revokeTokens","db","expires","Date","all","AccessToken","where","userId","RefreshToken","classMethods","associate","belongsTo","Role","foreignKey","as","checkEmailExists","count","then","rows","checkMobileExists","checkExists","e","m","hooks","beforeCreate","instance","changed","set","beforeUpdate"],"mappings":";;;;;;;;;;;;;;kBAMe,UAAUA,SAAV,EAAqBC,SAArB,EAAgC;AAC7C,MAAMC,OAAOF,UAAUG,MAAV,CAAiB,MAAjB,EAAyB;AACpCC,QAAI;AACFC,YAAMJ,UAAUK,OADd;AAEFC,iBAAW,KAFT;AAGFC,kBAAY,IAHV;AAIFC,qBAAe;AAJb,KADgC;AAOpCC,UAAMT,UAAUU,MAPoB;AAQpCC,YAAQX,UAAUK,OARkB;AASpCO,WAAOZ,UAAUU,MATmB;AAUpCG,SAAKb,UAAUU,MAVqB;AAWpCI,eAAWd,UAAUK,OAXe;AAYpCU,cAAUf,UAAUU,MAZgB;AAapCM,YAAQhB,UAAUiB,OAbkB;AAcpCC,WAAOlB,UAAUK,OAdmB;AAepCc,iBAAanB,UAAUU,MAfa;AAgBpCU,iBAAapB,UAAUU,MAhBa;AAiBpCW,iBAAarB,UAAUU,MAjBa;AAkBpCY,mBAAetB,UAAUuB,MAlBW;AAmBpCC,kBAAcxB,UAAUU,MAnBY;AAoBpCe,cAAUzB,UAAUU,MApBgB;AAqBpCgB,cAAU1B,UAAUU,MArBgB;AAsBpCiB,iBAAa3B,UAAUiB,OAtBa;AAuBpCW,eAAW5B,UAAUiB,OAvBe;AAwBpCY,4BAAwB7B,UAAUK,OAxBE;AAyBpCyB,0BAAsB9B,UAAUK,OAzBI;AA0BpC0B,0BAAsB/B,UAAUK,OA1BI;AA2BpC2B,wBAAoBhC,UAAUK,OA3BM;AA4BpC4B,kBAAcjC,UAAUK,OA5BY;AA6BpC6B,gBAAYlC,UAAUK,OA7Bc;AA8BpC8B,uBAAmBnC,UAAUK,OA9BO;AA+BpC+B,qBAAiBpC,UAAUK,OA/BS;AAgCpCgC,eAAWrC,UAAUsC,IAhCe;AAiCpCC,iCAA6BvC,UAAUK,OAjCH;AAkCpCmC,iCAA6BxC,UAAUK,OAlCH;AAmCpCoC,+BAA2BzC,UAAUK,OAnCD;AAoCpCqC,+BAA2B1C,UAAUK,OApCD;AAqCpCsC,4BAAwB3C,UAAUK,OArCE;AAsCpCuC,4BAAwB5C,UAAUK,OAtCE;AAuCpCwC,uBAAmB7C,UAAUK,OAvCO;AAwCpCyC,uBAAmB9C,UAAUK;AAxCO,GAAzB,EAyCV;AACD0C,eAAW,OADV;AAEDC,gBAAY,IAFX;AAGDC,cAAU,IAHT;AAIDC,qBAAiB;AACfC,kBADe,wBACFpC,QADE,EACQ;AACrB,eAAO,iBACJqC,UADI,CACO,KADP,EAEJC,MAFI,CAEGC,OAAOvC,QAFV,EAGJwC,MAHI,CAGG,KAHH,CAAP;AAID,OANc;AAOfC,yBAPe,+BAOKzC,QAPL,EAOe;AAC5B,YAAM0C,aAAa,iBAChBL,UADgB,CACL,KADK,EAEhBC,MAFgB,CAETC,OAAOvC,QAFE,EAGhBwC,MAHgB,CAGT,KAHS,CAAnB;AAIA,eAAQE,eAAe,KAAK1C,QAArB,GAAiC,kBAAQ2C,OAAR,CAAgB,iBAAEC,IAAF,CAAO,KAAKC,MAAL,EAAP,EAAsB,CAAC,IAAD,CAAtB,CAAhB,CAAjC,GACH,kBAAQC,MAAR,CAAe,EAAEC,MAAM,GAAR,EAAaC,SAAS,iBAAtB,EAAf,CADJ;AAED,OAdc;AAefC,oBAfe,0BAeAjD,QAfA,EAeUkD,EAfV,EAec;AAC3B,eAAQhE,KAAKkD,YAAL,CAAkBpC,QAAlB,MAAgC,KAAKA,QAAtC,GACLkD,GAAG,IAAH,EAAS,KAAKL,MAAL,EAAT,CADK,GACqBK,GAAG,IAAH,EAAS,KAAT,CAD5B;AAED,OAlBc;AAoBfC,kBApBe,wBAoBFC,EApBE,EAoBE;AACf,YAAMC,UAAU,IAAIC,IAAJ,EAAhB;AACA,eAAO,kBAAQC,GAAR,CAAY,CACjBH,GAAGI,WAAH,CAAelB,MAAf,CACE,EAAEe,gBAAF,EADF,EAEE,EAAEI,OAAO,EAAEC,QAAQ,KAAKtE,EAAf,EAAT,EAFF,CADiB,EAIjBgE,GAAGO,YAAH,CAAgBrB,MAAhB,CACE,EAAEe,gBAAF,EADF,EAEE,EAAEI,OAAO,EAAEC,QAAQ,KAAKtE,EAAf,EAAT,EAFF,CAJiB,CAAZ,CAAP;AAQD;AA9Bc,KAJhB;;AAqCDwE,kBAAc;AACZC,eADY,qBACFT,EADE,EACE;AACZlE,aAAK4E,SAAL,CAAeV,GAAGW,IAAlB,EAAwB;AACtBC,sBAAY;AADU,SAAxB;AAGA9E,aAAK4E,SAAL,CAAe5E,IAAf,EAAqB;AACnB8E,sBAAY,WADO;AAEnBzE,qBAAW,IAFQ;AAGnB0E,cAAI;AAHe,SAArB;AAKA/E,aAAK4E,SAAL,CAAe5E,IAAf,EAAqB;AACnB8E,sBAAY,YADO;AAEnBzE,qBAAW,IAFQ;AAGnB0E,cAAI;AAHe,SAArB;AAKD,OAfW;AAgBZC,sBAhBY,4BAgBKd,EAhBL,EAgBSvD,KAhBT,EAgBgB;AAC1B,eAAOuD,GAAGlE,IAAH,CAAQiF,KAAR,CAAc,EAAEV,OAAO,EAAE5D,YAAF,EAAT,EAAd,EAAoCuE,IAApC,CAAyC,UAACC,IAAD,EAAU;AACxD,cAAIA,OAAO,CAAX,EAAc,OAAO,kBAAQ1B,OAAR,CAAgB,IAAhB,CAAP;AACd,iBAAO,kBAAQA,OAAR,CAAgB,KAAhB,CAAP;AACD,SAHM,CAAP;AAID,OArBW;AAsBZ2B,uBAtBY,6BAsBMlB,EAtBN,EAsBUxD,MAtBV,EAsBkB;AAC5B,eAAOwD,GAAGlE,IAAH,CAAQiF,KAAR,CAAc,EAAEV,OAAO,EAAE7D,cAAF,EAAT,EAAd,EAAqCwE,IAArC,CAA0C,UAACC,IAAD,EAAU;AACzD,cAAIA,OAAO,CAAX,EAAc,OAAO,kBAAQ1B,OAAR,CAAgB,IAAhB,CAAP;AACd,iBAAO,kBAAQA,OAAR,CAAgB,KAAhB,CAAP;AACD,SAHM,CAAP;AAID,OA3BW;AA4BZ4B,iBA5BY,uBA4BAnB,EA5BA,EA4BIvD,KA5BJ,EA4BWD,MA5BX,EA4BmB;AAC7B,eAAO,kBAAQ2D,GAAR,CAAY,CACjB1D,QAAQuD,GAAGlE,IAAH,CAAQgF,gBAAR,CAAyBd,EAAzB,EAA6BvD,KAA7B,CAAR,GAA8C,kBAAQ8C,OAAR,CAAgB,KAAhB,CAD7B,EAEjB/C,SAASwD,GAAGlE,IAAH,CAAQoF,iBAAR,CAA0BlB,EAA1B,EAA8BxD,MAA9B,CAAT,GAAiD,kBAAQ+C,OAAR,CAAgB,KAAhB,CAFhC,CAAZ,EAIJyB,IAJI,CAIC;AAAA;AAAA,cAAEI,CAAF;AAAA,cAAKC,CAAL;;AAAA,iBAAa,EAAE5E,OAAO2E,CAAT,EAAY5E,QAAQ6E,CAApB,EAAb;AAAA,SAJD,CAAP;AAKD,OAlCW;AAmCZrC,kBAnCY,wBAmCCpC,QAnCD,EAmCW;AACrB,eAAO,iBACJqC,UADI,CACO,KADP,EAEJC,MAFI,CAEGC,OAAOvC,QAFV,EAGJwC,MAHI,CAGG,KAHH,CAAP;AAID;AAxCW,KArCb;AA+EDkC,WAAO;AACLC,kBADK,wBACQC,QADR,EACkB;AACrB,YAAIA,SAASC,OAAT,CAAiB,UAAjB,CAAJ,EAAkC;AAChCD,mBACGE,GADH,CACO,UADP,EACmBF,SAASxC,YAAT,CAAsBwC,SAAS5E,QAA/B,CADnB;AAED;AACF,OANI;AAQL+E,kBARK,wBAQQH,QARR,EAQkB;AACrB,YAAIA,SAASC,OAAT,CAAiB,UAAjB,CAAJ,EAAkC;AAChCD,mBACGE,GADH,CACO,UADP,EACmBF,SAASxC,YAAT,CAAsBwC,SAAS5E,QAA/B,CADnB;AAED;AACF;AAbI;AA/EN,GAzCU,CAAb;;AAyIA,SAAOd,IAAP;AACD,C;;AAhJD;;;;AACA;;;;;;AAEA,IAAMqD,OAAO,kEAAb","file":"user.model.js","sourcesContent":["\nimport _ from 'lodash';\nimport crypto from 'crypto';\n\nconst salt = 'DYhG93b0fIxfs2guVoUubasdfajfkljasdjfaklsdjflakrfWwvniR2G0FgaC9mi';\n\nexport default function (sequelize, DataTypes) {\n  const User = sequelize.define('User', {\n    id: {\n      type: DataTypes.INTEGER,\n      allowNull: false,\n      primaryKey: true,\n      autoIncrement: true,\n    },\n    name: DataTypes.STRING,\n    mobile: DataTypes.INTEGER,\n    email: DataTypes.STRING,\n    otp: DataTypes.STRING,\n    otpStatus: DataTypes.INTEGER,\n    password: DataTypes.STRING,\n    active: DataTypes.BOOLEAN,\n    admin: DataTypes.INTEGER,\n    companyName: DataTypes.STRING,\n    companyLogo: DataTypes.STRING,\n    supportName: DataTypes.STRING,\n    supportMobile: DataTypes.BIGINT,\n    supportEmail: DataTypes.STRING,\n    loginUrl: DataTypes.STRING,\n    slackUrl: DataTypes.STRING,\n    slackActive: DataTypes.BOOLEAN,\n    smsActive: DataTypes.BOOLEAN,\n    transactionalStartFrom: DataTypes.INTEGER,\n    transactionalPercent: DataTypes.INTEGER,\n    promotionalStartFrom: DataTypes.INTEGER,\n    promotionalPercent: DataTypes.INTEGER,\n    otpStartFrom: DataTypes.INTEGER,\n    otpPercent: DataTypes.INTEGER,\n    senderIdStartFrom: DataTypes.INTEGER,\n    senderIdPercent: DataTypes.INTEGER,\n    expiresAt: DataTypes.DATE,\n    sellingBalanceTransactional: DataTypes.INTEGER,\n    sendingBalanceTransactional: DataTypes.INTEGER,\n    sellingBalancePromotional: DataTypes.INTEGER,\n    sendingBalancePromotional: DataTypes.INTEGER,\n    sellingBalanceSenderId: DataTypes.INTEGER,\n    sendingBalanceSenderId: DataTypes.INTEGER,\n    sellingBalanceOTP: DataTypes.INTEGER,\n    sendingBalanceOTP: DataTypes.INTEGER,\n  }, {\n    tableName: 'users',\n    timestamps: true,\n    paranoid: true,\n    instanceMethods: {\n      hashPassword(password) {\n        return crypto\n          .createHash('md5')\n          .update(salt + password)\n          .digest('hex');\n      },\n      verifyPasswordAsync(password) {\n        const hashedPass = crypto\n          .createHash('md5')\n          .update(salt + password)\n          .digest('hex');\n        return (hashedPass === this.password) ? Promise.resolve(_.pick(this.toJSON(), ['id']))\n          : Promise.reject({ code: 400, message: 'Check password!' });\n      },\n      verifyPassword(password, cb) {\n        return (User.hashPassword(password) === this.password) ?\n          cb(null, this.toJSON()) : cb(null, false);\n      },\n\n      revokeTokens(db) {\n        const expires = new Date();\n        return Promise.all([\n          db.AccessToken.update(\n            { expires },\n            { where: { userId: this.id } }),\n          db.RefreshToken.update(\n            { expires },\n            { where: { userId: this.id } }),\n        ]);\n      },\n    },\n\n    classMethods: {\n      associate(db) {\n        User.belongsTo(db.Role, {\n          foreignKey: 'roleId',\n        });\n        User.belongsTo(User, {\n          foreignKey: 'createdBy',\n          allowNull: true,\n          as: 'CreatedBy',\n        });\n        User.belongsTo(User, {\n          foreignKey: 'resellerId',\n          allowNull: true,\n          as: 'ResellerId',\n        });\n      },\n      checkEmailExists(db, email) {\n        return db.User.count({ where: { email } }).then((rows) => {\n          if (rows > 0) return Promise.resolve(true);\n          return Promise.resolve(false);\n        });\n      },\n      checkMobileExists(db, mobile) {\n        return db.User.count({ where: { mobile } }).then((rows) => {\n          if (rows > 0) return Promise.resolve(true);\n          return Promise.resolve(false);\n        });\n      },\n      checkExists(db, email, mobile) {\n        return Promise.all([\n          email ? db.User.checkEmailExists(db, email) : Promise.resolve(false),\n          mobile ? db.User.checkMobileExists(db, mobile) : Promise.resolve(false),\n        ])\n          .then(([e, m]) => ({ email: e, mobile: m }));\n      },\n      hashPassword(password) {\n        return crypto\n          .createHash('md5')\n          .update(salt + password)\n          .digest('hex');\n      },\n    },\n    hooks: {\n      beforeCreate(instance) {\n        if (instance.changed('password')) {\n          instance\n            .set('password', instance.hashPassword(instance.password));\n        }\n      },\n\n      beforeUpdate(instance) {\n        if (instance.changed('password')) {\n          instance\n            .set('password', instance.hashPassword(instance.password));\n        }\n      },\n    },\n  });\n\n  return User;\n}\n"]}