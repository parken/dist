{"version":3,"sources":["components/packageManager/index.js"],"names":["PackageManager","activePackages","userId","packageTypeId","UserPackage","findAll","attributes","where","order","packageUsage","userPackageId","Transaction","Sequelize","fn","col","group","then","result","forEach","usage","packagesUsage","filter","x","id","length","toJSON","count","availableLimit","reject","message","map","userPackage","uP","used"],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,IAAMA,iBAAiB;AACrBC,gBADqB,0BACNC,MADM,EACEC,aADF,EACiB;AACpC,WAAO,gBAAGC,WAAH,CACJC,OADI,CACI;AACPC,kBAAY,CAAC,WAAD,EAAc,IAAd,EAAoB,eAApB,CADL;AAEPC,aAAO,EAAEJ,4BAAF,EAAiBD,cAAjB,EAFA;AAGPM,aAAO,CAAC,CAAC,WAAD,EAAc,MAAd,CAAD;AAHA,KADJ,CAAP;AAMD,GARoB;AASrBC,cATqB,wBASRC,aATQ,EASOR,MATP,EASe;AAClC,WAAO,gBAAGS,WAAH,CAAeN,OAAf,CAAuB;AAC5BC,kBAAY,CAAC,eAAD,EACV,CAAC,gBAAGM,SAAH,CAAaC,EAAb,CAAgB,OAAhB,EAAyB,gBAAGD,SAAH,CAAaE,GAAb,CAAiB,eAAjB,CAAzB,CAAD,EAA8D,OAA9D,CADU,CADgB;AAG5BP,aAAO,EAAEL,cAAF,EAAUQ,4BAAV,EAHqB;AAI5BK,aAAO;AAJqB,KAAvB,EAKJC,IALI,CAKC,yBAAiB;AACvB,UAAMC,SAAS,EAAf;AACAP,oBAAcQ,OAAd,CAAsB,cAAM;AAC1B,YAAIC,QAAQC,cAAcC,MAAd,CAAqB;AAAA,iBAAMC,EAAEZ,aAAF,KAAoBa,EAA1B;AAAA,SAArB,CAAZ;AACA,YAAIJ,MAAMK,MAAV,EAAkBL,QAAQA,MAAM,CAAN,EAASM,MAAT,EAAR,CAAlB,KACKN,QAAQ,EAAEO,OAAO,CAAT,EAAR;AACLT,eAAOM,EAAP,IAAaJ,MAAMO,KAAnB;AACD,OALD;AAMA,aAAOT,MAAP;AACD,KAdM,CAAP;AAeD,GAzBoB;AA0BrBU,gBA1BqB,0BA0BNzB,MA1BM,EA0BEC,aA1BF,EA0BiB;AACpC,WAAOH,eAAeC,cAAf,CAA8BC,MAA9B,EAAsCC,aAAtC,EACJa,IADI,CACC,0BAAkB;AACtB,UAAI,CAACf,eAAeuB,MAApB,EAA4B,OAAO,kBAAQI,MAAR,CAAe,EAAEC,SAAS,uBAAX,EAAf,CAAP;AAC5B,aAAO7B,eAAeS,YAAf,CAA4BR,eAAe6B,GAAf,CAAmB;AAAA,eAAKR,EAAEC,EAAP;AAAA,OAAnB,CAA5B,EAA2DrB,MAA3D,EACJc,IADI,CACC;AAAA,eAAiBf,eAAe6B,GAAf,CAAmB,cAAM;AAC9C,cAAMC,cAAcC,GAAGP,MAAH,EAApB;AACAM,sBAAYE,IAAZ,GAAmBb,cAAcW,YAAYR,EAA1B,CAAnB;AACA,iBAAOQ,WAAP;AACD,SAJsB,CAAjB;AAAA,OADD,CAAP;AAMD,KATI,CAAP;AAUD;AArCoB,CAAvB;;kBAwCe/B,c","file":"index.js","sourcesContent":["import db from '../../conn/sqldb';\n\nconst PackageManager = {\n  activePackages(userId, packageTypeId) {\n    return db.UserPackage\n      .findAll({\n        attributes: ['allocated', 'id', 'packageTypeId'],\n        where: { packageTypeId, userId },\n        order: [['createdAt', 'DESC']],\n      });\n  },\n  packageUsage(userPackageId, userId) {\n    return db.Transaction.findAll({\n      attributes: ['userPackageId',\n        [db.Sequelize.fn('COUNT', db.Sequelize.col('userPackageId')), 'count']],\n      where: { userId, userPackageId },\n      group: 'userPackageId',\n    }).then(packagesUsage => {\n      const result = {};\n      userPackageId.forEach(id => {\n        let usage = packagesUsage.filter(x => (x.userPackageId === id));\n        if (usage.length) usage = usage[0].toJSON();\n        else usage = { count: 0 };\n        result[id] = usage.count;\n      });\n      return result;\n    });\n  },\n  availableLimit(userId, packageTypeId) {\n    return PackageManager.activePackages(userId, packageTypeId)\n      .then(activePackages => {\n        if (!activePackages.length) return Promise.reject({ message: 'No Package Available.' });\n        return PackageManager.packageUsage(activePackages.map(x => x.id), userId)\n          .then(packagesUsage => activePackages.map(uP => {\n            const userPackage = uP.toJSON();\n            userPackage.used = packagesUsage[userPackage.id];\n            return userPackage;\n          }));\n      });\n  },\n};\n\nexport default PackageManager;\n"]}